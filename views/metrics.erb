<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Meme Explorer Metrics Dashboard ðŸ“Š</title>
  <style>
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      margin: 2rem;
      background-color: #f4f5f7;
      color: #333;
    }

    h1 {
      text-align: center;
      margin-bottom: 1rem;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 2rem;
      margin-bottom: 2rem;
    }

    .card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      padding: 1.5rem;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    }

    ul { list-style: none; padding: 0; line-height: 1.6; }
    li { margin-bottom: 0.5rem; }

    .badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 8px;
      font-weight: bold;
      color: #fff;
      font-size: 0.9rem;
    }
    .badge-blue { background-color: #2c7be5; }
    .badge-green { background-color: #1db954; }
    .badge-red { background-color: #e63757; }
    .badge-yellow { background-color: #ffbf47; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
    }
    th, td {
      padding: 0.5rem;
      text-align: left;
    }
    th {
      background-color: #f0f0f0;
    }
    tr:nth-child(even) {
      background-color: #fafafa;
    }

    .charts {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 2rem;
      margin-top: 2rem;
    }
  </style>
</head>
<body>
  <h1>Meme Explorer Metrics Dashboard ðŸ“Š</h1>
  <p style="text-align:center; margin-bottom:2rem;">
    Last meme fetch from API: <%= last_batch&.strftime("%B %d, %Y %H:%M:%S") || "N/A" %>
  </p>

  <!-- First Row: Overall Stats & Cache Metrics -->
  <div class="dashboard-grid">
    <!-- Overall Stats -->
    <div class="card">
      <h2>Overall Stats</h2>
      <ul>
        <li>Total memes tracked: <span class="badge badge-blue"><%= total_memes %></span></li>
        <li>Total likes: <span class="badge badge-green"><%= total_likes %></span></li>
        <li>Total views: <span class="badge badge-green"><%= total_views %></span></li>
        <li>Average likes per meme: <span class="badge badge-blue"><%= avg_likes %></span></li>
        <li>Average views per meme: <span class="badge badge-blue"><%= avg_views %></span></li>
        <li>Memes with no likes: <span class="badge badge-red"><%= memes_with_no_likes %></span></li>
        <li>Memes with no views: <span class="badge badge-red"><%= memes_with_no_views %></span></li>
      </ul>
    </div>

    <!-- Cache & In-Memory Metrics -->
    <div class="card">
      <h2>Cache & In-Memory Metrics</h2>
      <ul>
        <li>Redis views counter: <span class="badge badge-green"><%= redis_views %></span></li>
        <li>Redis likes counter: <span class="badge badge-green"><%= redis_likes %></span></li>
        <li>Redis memes with no views: <span class="badge badge-red"><%= redis_no_views %></span></li>
        <li>Redis memes with no likes: <span class="badge badge-red"><%= redis_no_likes %></span></li>
        <li>Average request time (ms): <span class="badge badge-yellow"><%= avg_request_time_ms.round(2) %></span></li>
        <li>Total requests: <span class="badge badge-blue"><%= total_requests %></span></li>
        <li>Cache hits: <span class="badge badge-green"><%= cache_hits %></span></li>
        <li>Cache misses: <span class="badge badge-red"><%= cache_misses %></span></li>
        <li>API calls: <span class="badge badge-blue"><%= api_calls %></span></li>
        <li>Tier 1 random calls: <span class="badge badge-yellow"><%= tier1_calls %></span></li>
        <li>Tier 2 random calls: <span class="badge badge-yellow"><%= tier2_calls %></span></li>
        <li>Tier 3 random calls: <span class="badge badge-yellow"><%= tier3_calls %></span></li>
      </ul>
    </div>
  </div>
<!-- Second Row: Top Memes Table -->
<div class="card">
  <h2>Top Memes</h2>
  <table>
    <thead>
      <tr>
        <th>Title</th>
        <th>Subreddit</th>
        <th style="text-align:center;">Likes</th>
        <th style="text-align:center;">Views</th>
      </tr>
    </thead>
    <tbody>
      <% (top_memes || []).each do |meme| %>
        <tr>
          <td>
            <a href="<%= meme["url"] %>" target="_blank" style="color:#2c7be5; text-decoration:none;">
              <%= meme["title"] %>
            </a>
          </td>
          <td><%= meme["subreddit"] %></td>
          <td style="text-align:center; color:#2c7be5;"><%= meme["likes"] %></td>
          <td style="text-align:center; color:#1db954;"><%= meme["views"] %></td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>

  <!-- Third Row: Top Subreddits Table -->
  <div class="card">
    <h2>Top Subreddits</h2>
    <table>
      <thead>
        <tr>
          <th>Subreddit</th>
          <th style="text-align:center;">Total Likes</th>
          <th style="text-align:center;">Memes Count</th>
        </tr>
      </thead>
      <tbody>
        <% (top_subreddits || []).each do |sub| %>
          <tr>
            <td><%= sub["subreddit"] %></td>
            <td style="text-align:center; color:#2c7be5;"><%= sub["total_likes"] %></td>
            <td style="text-align:center;"><%= sub["count"] %></td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <!-- Fourth Row: Charts / Trends Placeholder -->
  <div class="charts">
    <div class="card">
      <h2>Likes Over Time</h2>
      <canvas id="likesChart" height="100"></canvas>
    </div>
    <div class="card">
      <h2>Views Over Time</h2>
      <canvas id="viewsChart" height="100"></canvas>
    </div>
    <div class="card">
      <h2>Cache Hits vs Misses</h2>
      <canvas id="cacheChart" height="100"></canvas>
    </div>
  </div>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Example Chart.js data, you can replace with real data
    const likesChart = new Chart(document.getElementById('likesChart'), {
      type: 'line',
      data: {
        labels: ['Today','Yesterday','2 Days Ago','3 Days Ago','4 Days Ago'],
        datasets: [{
          label: 'Likes',
          data: [12, 19, 7, 15, 9],
          borderColor: '#2c7be5',
          fill: false,
          tension: 0.3
        }]
      }
    });

    const viewsChart = new Chart(document.getElementById('viewsChart'), {
      type: 'line',
      data: {
        labels: ['Today','Yesterday','2 Days Ago','3 Days Ago','4 Days Ago'],
        datasets: [{
          label: 'Views',
          data: [120, 190, 70, 150, 90],
          borderColor: '#1db954',
          fill: false,
          tension: 0.3
        }]
      }
    });

    const cacheChart = new Chart(document.getElementById('cacheChart'), {
      type: 'bar',
      data: {
        labels: ['Cache Hits', 'Cache Misses', 'API Calls'],
        datasets: [{
          label: 'Counts',
          data: [<%= cache_hits %>, <%= cache_misses %>, <%= api_calls %>],
          backgroundColor: ['#2c7be5','#e63757','#ffbf47']
        }]
      }
    });
  </script>
</body>
</html>
