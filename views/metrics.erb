<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Meme Metrics Dashboard</title>
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- DataTables CSS & JS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.min.css">
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>

  <style>
    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 2rem;
      background-color: #f5f6fa;
      color: #333;
    }

    h1 {
      text-align: center;
      margin-bottom: 2rem;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .card {
      background: #fff;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      text-align: center;
    }

    .card h3 {
      margin: 0.5rem 0;
      font-size: 1.2rem;
      color: #555;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 2rem;
    }

    th, td {
      padding: 0.5rem;
      border: 1px solid #ddd;
      text-align: left;
    }

    th {
      background-color: #2980b9;
      color: white;
      cursor: pointer;
    }

    a {
      color: #2980b9;
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    .chart-container {
      background: #fff;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
    }

    .badge {
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      color: #fff;
      font-weight: bold;
    }

    .badge-green { background-color: #27ae60; }
    .badge-red { background-color: #c0392b; }
    .badge-yellow { background-color: #f39c12; }
    .badge-blue { background-color: #2980b9; }

  </style>
</head>
<body>

  <h1>Meme Metrics Dashboard</h1>
  <p style="text-align:center;">
    Last updated: <%= @last_batch %> |
    Next batch in: <span id="nextBatchCountdown"></span>
  </p>

  <!-- Countdown Timer Script -->
  <script>
    // Batch interval in seconds (matches fetch_fresh_memes)
    const batchInterval = 120;

    // Last batch timestamp from server
    const lastBatchTime = new Date("<%= @last_batch %>").getTime();

    const countdownElement = document.getElementById('nextBatchCountdown');

    function updateCountdown() {
      const now = new Date().getTime();
      let secondsLeft = batchInterval - Math.floor((now - lastBatchTime) / 1000);
      if (secondsLeft < 0) secondsLeft = 0;
      const minutes = Math.floor(secondsLeft / 60);
      const seconds = secondsLeft % 60;
      countdownElement.textContent = `${minutes}m ${seconds}s`;
    }

    setInterval(updateCountdown, 1000);
    updateCountdown();
  </script>

  <!-- Stats Cards -->
  <div class="stats-grid">
    <div class="card">
      <h3>Total Memes</h3>
      <p><%= @total_memes %></p>
    </div>
    <div class="card">
      <h3>Total Likes</h3>
      <p><%= @total_likes %></p>
    </div>
    <div class="card">
      <h3>Total Views</h3>
      <p><%= @total_views %></p>
    </div>
    <div class="card">
      <h3>Average Likes</h3>
      <p><%= @avg_likes %></p>
    </div>
    <div class="card">
      <h3>Average Views</h3>
      <p><%= @avg_views %></p>
    </div>
    <div class="card">
      <h3>Memes with No Likes</h3>
      <p><%= @memes_with_no_likes %></p>
    </div>
    <div class="card">
      <h3>Memes with No Views</h3>
      <p><%= @memes_with_no_views %></p>
    </div>
  </div>

  <!-- Redis Counters -->
  <div class="stats-grid">
    <div class="card">
      <h3>Redis Likes</h3>
      <p><%= @redis_likes %></p>
    </div>
    <div class="card">
      <h3>Redis Views</h3>
      <p><%= @redis_views %></p>
    </div>
    <div class="card">
      <h3>Redis No Likes</h3>
      <p><%= @redis_no_likes %></p>
    </div>
    <div class="card">
      <h3>Redis No Views</h3>
      <p><%= @redis_no_views %></p>
    </div>
    <div class="card">
      <h3>Avg Request Time (ms)</h3>
      <p><%= @avg_request_time_ms.round(2) %></p>
    </div>
    <div class="card">
      <h3>Total Requests</h3>
      <p><%= @total_requests %></p>
    </div>
    <div class="card">
      <h3>Cache Hits</h3>
      <p><%= @cache_hits %></p>
    </div>
    <div class="card">
      <h3>Cache Misses</h3>
      <p><%= @cache_misses %></p>
    </div>
    <div class="card">
      <h3>API Calls</h3>
      <p><%= @api_calls %></p>
    </div>
    <div class="card">
      <h3>Tier 1 Random Calls</h3>
      <p><%= @tier1_calls %></p>
    </div>
    <div class="card">
      <h3>Tier 2 Random Calls</h3>
      <p><%= @tier2_calls %></p>
    </div>
    <div class="card">
      <h3>Tier 3 Random Calls</h3>
      <p><%= @tier3_calls %></p>
    </div>
  </div>

  <!-- Charts -->
  <div class="chart-container">
    <canvas id="likesViewsChart" height="100"></canvas>
  </div>

  <script>
    const ctx = document.getElementById('likesViewsChart').getContext('2d');
    const likesViewsChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: <%= @top_memes.map { |m| m["title"] }.to_json %>,
        datasets: [
          {
            label: 'Likes',
            data: <%= @top_memes.map { |m| m["likes"] }.to_json %>,
            backgroundColor: 'rgba(41, 128, 185, 0.7)'
          },
          {
            label: 'Views',
            data: <%= @top_memes.map { |m| m["views"] }.to_json %>,
            backgroundColor: 'rgba(231, 76, 60, 0.7)'
          }
        ]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'top' },
          title: { display: true, text: 'Top Memes Likes vs Views' }
        }
      }
    });
  </script>

  <!-- Tables -->
  <h2>Top 10 Memes by Likes</h2>
  <table id="memesTable">
    <thead>
      <tr>
        <th>Title</th>
        <th>Subreddit</th>
        <th>Likes</th>
        <th>Views</th>
        <th>URL</th>
      </tr>
    </thead>
    <tbody>
      <% @top_memes.each do |meme| %>
        <tr>
          <td><%= meme["title"] %></td>
          <td><%= meme["subreddit"] %></td>
          <td><%= meme["likes"] %></td>
          <td><%= meme["views"] %></td>
          <td><a href="<%= meme["url"] %>" target="_blank">link</a></td>
        </tr>
      <% end %>
    </tbody>
  </table>

  <h2>Top 10 Subreddits by Likes</h2>
  <table id="subredditsTable">
    <thead>
      <tr>
        <th>Subreddit</th>
        <th>Total Likes</th>
        <th>Memes Count</th>
      </tr>
    </thead>
    <tbody>
      <% @top_subreddits.each do |sub| %>
        <tr>
          <td><%= sub["subreddit"] %></td>
          <td><%= sub["total_likes"] %></td>
          <td><%= sub["count"] %></td>
        </tr>
      <% end %>
    </tbody>
  </table>

  <script>
    $(document).ready(function () {
      $('#memesTable').DataTable({
        pageLength: 10,
        lengthChange: false
      });
      $('#subredditsTable').DataTable({
        pageLength: 10,
        lengthChange: false
      });
    });
  </script>

</body>
</html>
