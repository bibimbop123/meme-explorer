<% if @meme && @meme.is_a?(Hash) && @meme["title"] %>
<div class="meme-single" style="width: 100%; max-width: 800px; margin: 0 auto;">
  <h2 id="meme-title" style="margin: 0.5em 0; word-wrap: break-word;">
    <%= @meme["title"] || "Untitled Meme" %>
  </h2>
  <p id="meme-subreddit" class="meme-subtitle" style="margin: 0.25em 0 1em;">
    <%= @meme["subreddit"] || "Unknown Subreddit" %>
  </p>

  <img
    id="meme-img"
    src="<%= @image_src || '/images/funny1.jpeg' %>"
    alt="<%= @meme["title"] || 'Meme Image' %>"
    onerror="handleImageError(this);"
    style="width: 100%; height: auto; border-radius: 12px; display: block; margin-bottom: 0.5em;"
  >

  <div id="reddit-link-container" style="text-align: center; margin-bottom: 1em;">
    <% if @reddit_path && !@reddit_path.empty? && !@image_src.start_with?("/images") %>
      <a id="reddit-link"
         href="https://www.reddit.com<%= @reddit_path %>"
         target="_blank" rel="noopener noreferrer"
         style="font-size: 0.9rem; color: #4caf50; text-decoration: none; font-weight: bold;">
        View on Reddit
      </a>
    <% else %>
      <a id="reddit-link" style="display:none;"></a>
    <% end %>
  </div>

  <div style="margin: 1em 0; display: flex; justify-content: center; align-items: center; gap: 1em; flex-wrap: wrap;">
    <button type="button"
            onclick="window.goPrevious()"
            style="padding: 0.75em 1.5em; border-radius: 8px; border: none; cursor: pointer; background: #2196F3; color: white; font-weight: bold; transition: 0.2s; font-size: 0.95rem;">
      â¬…ï¸ Previous
    </button>

    <form class="like-form" action="/like" method="POST" style="display: flex; justify-content: center; align-items: center; gap: 1em; flex-wrap: wrap;">
      <input type="hidden" name="url" value="<%= @image_src %>">
      <input type="hidden" name="title" value="<%= @meme["title"] %>">
      <input type="hidden" name="subreddit" value="<%= @meme["subreddit"] %>">
      <span style="font-weight: bold; white-space: nowrap;">
        Likes: <span class="meme-likes"><%= @likes.to_i > 0 ? @likes.to_i : "0" %></span>
      </span>
      <button type="submit"
              class="<%= 'liked' if session[:liked_memes]&.include?(@image_src) %>"
              style="padding: 0.75em 1.5em; border-radius: 8px; border: none; cursor: pointer; background: #e52e71; color: white; font-weight: bold; transition: 0.2s; font-size: 0.95rem;">
        <%= session[:liked_memes]&.include?(@image_src) ? "ğŸ’” Unlike" : "â¤ï¸ Like" %>
      </button>
      <% if session[:user_id] %>
        <button type="button"
                id="save-btn"
                onclick="toggleSaveMeme()"
                style="padding: 0.75em 1.5em; border-radius: 8px; border: none; cursor: pointer; background: #4caf50; color: white; font-weight: bold; transition: 0.2s; font-size: 0.95rem;">
          ğŸ“Œ Save
        </button>
      <% else %>
        <a href="/login" style="padding: 0.75em 1.5em; border-radius: 8px; background: #999; color: white; text-decoration: none; font-weight: bold; cursor: pointer; font-size: 0.95rem;">
          Login to Save
        </a>
      <% end %>
    </form>

    <button type="button"
            onclick="window.goNext()"
            style="padding: 0.75em 1.5em; border-radius: 8px; border: none; cursor: pointer; background: #ff9800; color: white; font-weight: bold; transition: 0.2s; font-size: 0.95rem;">
      Next â¡ï¸
    </button>
  </div>
</div>
<% else %>
<div style="text-align: center; margin-top: 50px; font-size: 18px;">
  <p>Loading memes...</p>
</div>
<% end %>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const memeImg = document.getElementById("meme-img");
  const memeTitle = document.getElementById("meme-title");
  const memeSub = document.getElementById("meme-subreddit");
  const likesSpan = document.querySelector(".meme-likes");
  const likeButton = document.querySelector("form.like-form button");
  const form = document.querySelector("form.like-form");
  const redditLink = document.getElementById("reddit-link");

  if (!memeImg || !memeTitle || !memeSub || !likesSpan || !likeButton || !form || !redditLink) return;

  let historyStack = [];
  let currentMeme = {
    url: memeImg.src,
    title: memeTitle.innerText,
    subreddit: memeSub.innerText,
    likes: parseInt(likesSpan.innerText) || 0,
    reddit_path: redditLink.href !== "#" ? redditLink.href.replace("https://www.reddit.com", "") : ""
  };

  if (!window.sessionLikedMemes) window.sessionLikedMemes = <%= (session[:liked_memes] || []).to_json %>;

  const updateMeme = (meme) => {
    memeImg.src = meme.url || '/images/funny1.jpeg';
    memeImg.alt = meme.title || "Meme Image";
    memeTitle.innerText = meme.title || "Untitled Meme";
    memeSub.innerText = meme.subreddit || "Unknown Subreddit";
    form.querySelector("input[name='url']").value = meme.url || "";
    likesSpan.textContent = meme.likes > 0 ? meme.likes : "0";

    if (meme.reddit_path && meme.reddit_path.trim() !== "" && !meme.url.startsWith("/images")) {
      redditLink.href = "https://www.reddit.com" + meme.reddit_path;
      redditLink.style.display = "inline";
    } else {
      redditLink.href = "#";
      redditLink.style.display = "none";
    }

    if (window.sessionLikedMemes.includes(meme.url)) {
      likeButton.textContent = "ğŸ’” Unlike";
      likeButton.classList.add("liked");
    } else {
      likeButton.textContent = "â¤ï¸ Like";
      likeButton.classList.remove("liked");
    }

    currentMeme = meme;
  };

  form.addEventListener("submit", async e => {
    e.preventDefault();
    const memeUrl = form.querySelector("input[name='url']").value;
    try {
      const res = await fetch(form.action, {
        method: "POST",
        body: new URLSearchParams({ url: memeUrl }),
        headers: { "Accept": "application/json" }
      });
      const data = await res.json();

      if (data.liked) {
        likeButton.textContent = "ğŸ’” Unlike";
        likeButton.classList.add("liked");
        if (!window.sessionLikedMemes.includes(memeUrl)) window.sessionLikedMemes.push(memeUrl);
      } else {
        likeButton.textContent = "â¤ï¸ Like";
        likeButton.classList.remove("liked");
        window.sessionLikedMemes = window.sessionLikedMemes.filter(u => u !== memeUrl);
      }
      likesSpan.textContent = data.likes > 0 ? data.likes : "0";
    } catch(err) {
      console.error("Like error:", err);
    }
  });

  window.handleImageError = async function(img) {
    const brokenUrl = img.src;
    try {
      await fetch("/report-broken-image", {
        method: "POST",
        body: new URLSearchParams({ url: brokenUrl }),
        headers: { "Accept": "application/json" }
      });
    } catch(err) {}
    goNext();
  };

  window.goNext = async function() {
    // Prevent rapid simultaneous requests on mobile
    if (window.isNavigating) {
      console.warn("Navigation already in progress");
      return;
    }
    
    window.isNavigating = true;
    historyStack.push(currentMeme);
    showLoadingOverlay();
    
    try {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
      
      const res = await fetch("/random.json", { signal: controller.signal });
      clearTimeout(timeoutId);
      
      if (!res.ok) throw new Error(`HTTP ${res.status}: Failed to fetch meme`);
      
      const meme = await res.json();
      if (!meme || !meme.url) throw new Error("Invalid meme data received");
      
      meme.likes = parseInt(meme.likes) || 0;
      updateMeme(meme);
      hideLoadingOverlay();
    } catch(err) {
      console.error("Navigation error:", err);
      historyStack.pop();
      hideLoadingOverlay();
      // Show error to user but allow retry
      alert("Unable to load next meme. Please try again.");
    } finally {
      window.isNavigating = false;
    }
  };
  
  window.showLoadingOverlay = function() {
    let overlay = document.getElementById("loading-overlay");
    if (!overlay) {
      overlay = document.createElement("div");
      overlay.id = "loading-overlay";
      overlay.className = "loading-overlay";
      overlay.innerHTML = '<div class="loading-container"><div class="meme-collector"><div class="frame frame-1">ğŸ“¸</div><div class="frame frame-2">ğŸ“·</div><div class="frame frame-3">ğŸ–¼ï¸</div><div class="collector-center">âœ¨</div></div><p class="loading-message">Finding the best memes for you...</p><div class="particles"><span class="particle">ğŸ˜‚</span><span class="particle">ğŸ¤£</span><span class="particle">ğŸ˜</span><span class="particle">ğŸ”¥</span><span class="particle">ğŸ’¯</span></div></div>';
      document.body.appendChild(overlay);
    }
    overlay.classList.remove("hidden");
    window.messageIndex = (window.messageIndex + 1) % window.loadingMessages.length;
    const messageEl = overlay.querySelector(".loading-message");
    if (messageEl) messageEl.textContent = window.loadingMessages[window.messageIndex];
  };
  
  window.hideLoadingOverlay = function() {
    const overlay = document.getElementById("loading-overlay");
    if (overlay) overlay.classList.add("hidden");
  };

  window.goPrevious = function() {
    // Prevent rapid clicks
    if (window.isNavigating) return;
    
    if (historyStack.length > 0) {
      window.isNavigating = true;
      updateMeme(historyStack.pop());
      // Reset navigation flag quickly for previous since it's instant
      setTimeout(() => { window.isNavigating = false; }, 100);
    }
  };

  document.addEventListener("keydown", e => {
    if ((e.code === "Space" || e.key === " ") && document.activeElement.tagName !== "INPUT") {
      e.preventDefault();
      if (e.shiftKey) window.goPrevious(); else window.goNext();
    }
  });

  // Initialize navigation flag
  window.isNavigating = false;
  window.loadingMessages = [
    "Finding the best memes for you...",
    "Searching the meme vaults...",
    "Assembling your entertainment...",
    "Loading the good stuff...",
    "Gathering the laughs..."
  ];
  window.messageIndex = 0;
});

window.toggleSaveMeme = function() {
  const url = document.querySelector("input[name='url']").value;
  const title = document.querySelector("input[name='title']").value;
  const subreddit = document.querySelector("input[name='subreddit']").value;
  const saveBtn = document.getElementById("save-btn");

  fetch("/api/save-meme", {
    method: "POST",
    body: new URLSearchParams({ url: url, title: title, subreddit: subreddit }),
    headers: { "Accept": "application/json" }
  })
  .then(res => res.json())
  .then(data => {
    if (data.saved) {
      alert("Meme saved! âœ…");
      saveBtn.style.background = "#2196F3";
      saveBtn.textContent = "âœ… Saved";
      saveBtn.disabled = true;
    }
  })
  .catch(err => alert("Error: " + err));
};
</script>
