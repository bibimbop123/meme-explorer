<div class="meme-container">
  <div class="meme-display">
    <% if @meme %>
      <img src="<%= @image_src %>" alt="<%= @meme['title'] %>" onerror="this.src='/images/funny1.jpeg'">
    <% else %>
      <div class="meme-loading"></div>
    <% end %>
  </div>
  
  <div class="meme-info">
    <div class="meme-title"><%= @meme&.dig('title') || 'Loading...' %></div>
    <span class="meme-subreddit"><%= @meme&.dig('subreddit')&.upcase || 'MEME' %></span>
  </div>

  <div class="meme-controls">
    <button class="control-btn" id="like-btn" title="Like this meme">
      ‚ù§Ô∏è
      <span class="control-count" id="like-count"><%= @likes || 0 %></span>
    </button>
    
    <button class="control-btn" id="save-btn" title="Save to profile">
      üîñ
      <span class="control-count">Save</span>
    </button>
    
    <button class="control-btn" id="share-btn" title="Share">
      üì§
      <span class="control-count">Share</span>
    </button>
    
    <button class="control-btn" id="next-btn" title="Next meme (Space or swipe)">
      ‚û°Ô∏è
      <span class="control-count">Next</span>
    </button>
  </div>

  <div class="nav-hint">Swipe or press Space ‚Üë</div>
</div>

<script>
  const memeUrl = '<%= @image_src %>';
  const memeSub = '<%= @meme&.dig("subreddit") || "reddit" %>';
  const memeTitle = '<%= @meme&.dig("title") || "Unknown" %>';
  
  const likeBtn = document.getElementById('like-btn');
  const likeCount = document.getElementById('like-count');
  const saveBtn = document.getElementById('save-btn');
  const nextBtn = document.getElementById('next-btn');
  
  let isLiked = window.sessionLikedMemes ? window.sessionLikedMemes.includes(memeUrl) : false;
  
  // Update like button UI
  function updateLikeUI() {
    if (isLiked) {
      likeBtn.style.color = '#ff4458';
      likeBtn.style.filter = 'drop-shadow(0 0 8px #ff4458)';
    } else {
      likeBtn.style.color = 'white';
      likeBtn.style.filter = 'none';
    }
  }
  
  updateLikeUI();
  
  // Like functionality
  likeBtn.addEventListener('click', async () => {
    try {
      const response = await fetch('/like', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `url=${encodeURIComponent(memeUrl)}`
      });
      
      if (response.ok) {
        const data = await response.json();
        isLiked = data.liked;
        likeCount.textContent = data.likes;
        updateLikeUI();
        
        // Haptic feedback
        if (navigator.vibrate) navigator.vibrate(50);
      }
    } catch (e) {
      console.error('Like error:', e);
    }
  });
  
  // Save functionality
  saveBtn.addEventListener('click', async () => {
    if (!<%= session[:user_id] ? 'true' : 'false' %>) {
      window.location.href = '/login';
      return;
    }
    
    try {
      const response = await fetch('/api/save-meme', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `url=${encodeURIComponent(memeUrl)}&title=${encodeURIComponent(memeTitle)}&subreddit=${encodeURIComponent(memeSub)}`
      });
      
      if (response.ok) {
        saveBtn.style.color = '#ff4458';
        saveBtn.style.filter = 'drop-shadow(0 0 8px #ff4458)';
        if (navigator.vibrate) navigator.vibrate([50, 30, 50]);
      }
    } catch (e) {
      console.error('Save error:', e);
    }
  });
  
  // Share functionality
  document.getElementById('share-btn').addEventListener('click', async () => {
    if (navigator.share) {
      try {
        await navigator.share({
          title: memeTitle,
          text: 'Check out this meme!',
          url: window.location.href
        });
      } catch (err) {
        console.log('Share cancelled');
      }
    } else {
      // Fallback: copy to clipboard
      navigator.clipboard.writeText(window.location.href).then(() => {
        alert('Link copied!');
      });
    }
  });
  
  // Keyboard & Swipe navigation
  let touchStartX = 0;
  let touchEndX = 0;
  
  document.addEventListener('keydown', (e) => {
    if (e.code === 'Space' && document.activeElement.tagName !== 'INPUT') {
      e.preventDefault();
      window.location.href = '/random';
    }
  });
  
  document.addEventListener('touchstart', (e) => {
    touchStartX = e.changedTouches[0].screenX;
  });
  
  document.addEventListener('touchend', (e) => {
    touchEndX = e.changedTouches[0].screenX;
    if (touchStartX - touchEndX > 50) {
      // Swiped left
      window.location.href = '/random';
    }
  });
</script>

<style>
  footer {
    display: none;
  }
</style>
